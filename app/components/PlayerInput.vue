<template>
  <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">
      ‚úèÔ∏è Nh·∫≠p Danh S√°ch Ng∆∞·ªùi Ch∆°i
    </h2>
    
    <!-- Th√¥ng b√°o khi c√≥ d·ªØ li·ªáu s·∫µn -->
    <div v-if="props.existingPlayers && props.existingPlayers.length > 0" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
      <div class="text-blue-700 text-sm">
        <span class="font-semibold">üìã ƒê√£ t·∫£i d·ªØ li·ªáu c√≥ s·∫µn:</span> 
        {{ props.existingPlayers.length }} ng∆∞·ªùi ch∆°i. B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a tr·ª±c ti·∫øp trong b·∫£ng b√™n d∆∞·ªõi.
      </div>
    </div>
    
    <div class="overflow-x-auto">
      <table class="w-full border-collapse bg-white rounded-lg shadow-sm">
        <thead>
          <tr class="bg-gray-100">
            <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">#</th>
            <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">T√™n Game</th>
            <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">ƒêi·ªÉm</th>
            <th class="border border-gray-300 px-3 py-2 text-left text-sm font-semibold">Lo·∫°i</th>
            <th class="border border-gray-300 px-3 py-2 text-center text-sm font-semibold">Thao T√°c</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(player, index) in sortedPlayers" :key="index" class="hover:bg-gray-50">
            <td class="border border-gray-300 px-3 py-2 text-center text-sm">{{ index + 1 }}</td>
            <td class="border border-gray-300 px-2 py-1">
              <input
                v-model="player.name"
                type="text"
                placeholder="Nh·∫≠p t√™n..."
                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </td>
            <td class="border border-gray-300 px-2 py-1">
              <input
                v-model.number="player.rank"
                type="number"
                min="1"
                max="23"
                placeholder="ƒêi·ªÉm (1-23)"
                class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </td>
            <td class="border border-gray-300 px-2 py-1 text-center">
              <span 
                v-if="player.rank" 
                class="text-xs px-2 py-1 rounded-full inline-block"
                :class="getRankBadgeClass(player.rank)"
              >
                {{ getRankCategory(player.rank) }}
              </span>
              <span v-else class="text-gray-400 text-xs">-</span>
            </td>
            <td class="border border-gray-300 px-2 py-1 text-center">
              <div class="flex justify-center space-x-1">
                <button
                  v-if="player.name && player.rank"
                  @click="deletePlayer(index)"
                  class="text-red-600 hover:text-red-800 text-sm font-medium px-2 py-1 rounded hover:bg-red-50"
                  title="X√≥a ng∆∞·ªùi ch∆°i n√†y"
                >
                  üóëÔ∏è
                </button>
                <button
                  v-if="!player.name || !player.rank"
                  @click="fillRandomPlayer(index)"
                  class="text-blue-600 hover:text-blue-800 text-sm font-medium px-2 py-1 rounded hover:bg-blue-50"
                  title="T·∫°o ng·∫´u nhi√™n"
                >
                  üé≤
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Th·ªëng k√™ -->
    <div v-if="playerCount > 0" class="mt-4 p-4 bg-gray-50 rounded-lg">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div class="text-center">
          <div class="font-semibold text-gray-700">T·ªïng ng∆∞·ªùi ch∆°i</div>
          <div class="text-lg font-bold text-blue-600">{{ playerCount }}/28</div>
        </div>
        <div class="text-center">
          <div class="font-semibold text-gray-700">Tr·ª• C·ªôt (A)</div>
          <div class="text-lg font-bold text-red-600">{{ getCategoryCount('A') }}</div>
        </div>
        <div class="text-center">
          <div class="font-semibold text-gray-700">Trung B√¨nh (B)</div>
          <div class="text-lg font-bold text-yellow-600">{{ getCategoryCount('B') }}</div>
        </div>
        <div class="text-center">
          <div class="font-semibold text-gray-700">H·ªó Tr·ª£ (C)</div>
          <div class="text-lg font-bold text-green-600">{{ getCategoryCount('C') }}</div>
        </div>
      </div>
    </div>

    <div class="mt-4 flex justify-between items-center">
      <div class="flex space-x-2">
        <button
          @click="addPlayers"
          class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
        >
          ‚úÖ X√°c Nh·∫≠n ({{ playerCount }}/28)
        </button>
        <button
          @click="generateRandomPlayers"
          class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
        >
          üé≤ T·∫°o Danh S√°ch Ng·∫´u Nhi√™n
        </button>
      </div>
      <button
        @click="clearAll"
        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
      >
        üóëÔ∏è X√≥a T·∫•t C·∫£
      </button>
    </div>
    
    <div v-if="error" class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
      {{ error }}
    </div>
    
    <div v-if="success" class="mt-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
      {{ success }}
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted } from 'vue'

const props = defineProps({
  existingPlayers: {
    type: Array,
    default: () => []
  }
})

const emit = defineEmits(['players-submitted', 'players-updated'])

const players = ref([])
const error = ref('')
const success = ref('')

// Initialize players array
const initializePlayers = () => {
  players.value = []
  for (let i = 0; i < 28; i++) {
    players.value.push({ name: '', rank: null })
  }
}

// Load existing players if available
onMounted(() => {
  if (props.existingPlayers && props.existingPlayers.length > 0) {
    // Load existing players and fill remaining slots
    players.value = [...props.existingPlayers]
    while (players.value.length < 28) {
      players.value.push({ name: '', rank: null })
    }
    console.log('‚úÖ Loaded existing players into input form')
  } else {
    initializePlayers()
  }
})

// Watch for changes in existingPlayers prop
watch(() => props.existingPlayers, (newPlayers) => {
  if (newPlayers && newPlayers.length > 0) {
    players.value = [...newPlayers]
    while (players.value.length < 28) {
      players.value.push({ name: '', rank: null })
    }
  }
}, { deep: true })

// Watch for changes in players and emit updates
watch(players, (newPlayers) => {
  const validPlayers = newPlayers.filter(p => p.name && p.rank)
  if (validPlayers.length > 0) {
    emit('players-updated', validPlayers)
  }
}, { deep: true })

// S·∫Øp x·∫øp danh s√°ch ng∆∞·ªùi ch∆°i theo ƒëi·ªÉm t·ª´ cao xu·ªëng th·∫•p
const sortedPlayers = computed(() => {
  return [...players.value].sort((a, b) => {
    // N·∫øu c·∫£ hai ƒë·ªÅu c√≥ ƒëi·ªÉm, s·∫Øp x·∫øp theo ƒëi·ªÉm (cao xu·ªëng th·∫•p)
    if (a.rank && b.rank) {
      return b.rank - a.rank
    }
    // N·∫øu ch·ªâ m·ªôt ng∆∞·ªùi c√≥ ƒëi·ªÉm, ng∆∞·ªùi c√≥ ƒëi·ªÉm ƒë·ª©ng tr∆∞·ªõc
    if (a.rank && !b.rank) return -1
    if (!a.rank && b.rank) return 1
    // N·∫øu c·∫£ hai ƒë·ªÅu kh√¥ng c√≥ ƒëi·ªÉm, gi·ªØ nguy√™n th·ª© t·ª±
    return 0
  })
})

const playerCount = computed(() => {
  return sortedPlayers.value.filter(p => p.name && p.rank).length
})

const clearAll = () => {
  players.value = []
  for (let i = 0; i < 28; i++) {
    players.value.push({ name: '', rank: null })
  }
  error.value = ''
  success.value = ''
}

const generateRandomPlayers = () => {
  error.value = ''
  success.value = ''
  
  // Danh s√°ch t√™n ng·∫´u nhi√™n
  const names = [
    'Li√™m', 'Ki·∫øp', 'F88', 'YB 1999', 'D√°nh ƒê√¥ng d·∫πp b·∫Øc', 'Pi', 'Trung con', 'Pheo',
    'Th·∫ßy Hi·ªáu Tr∆∞·ªüng', 'Ho√†ng Huy', 'Th√†nh Ph·∫°m', 'Vi·ªát B√©o', 'ƒêinh Xu√¢n H√†o', 'Dx T√°',
    'B·∫£nh', 'Hi·ªáp', 'B√© bom', 'Ng√¥ B·∫£o Long', 'T≈©n', 'Gi√°p Nguy·ªÖn', 'C·ª• gi√†', 'Kim Chung',
    'M√°y t√≠nh t·∫•t th·∫Øng', 'L∆∞u VƒÉn S·ªπ', 'Phong L√¢m', 'Tu·∫•n Tu·∫•n', 'Thang Tony', 'Koi'
  ]
  
  // T·∫°o 28 ng∆∞·ªùi ch∆°i ng·∫´u nhi√™n
  const randomPlayers = []
  const usedNames = new Set()
  
  for (let i = 0; i < 28; i++) {
    let name
    do {
      name = names[Math.floor(Math.random() * names.length)]
    } while (usedNames.has(name))
    
    usedNames.add(name)
    
    // Ph√¢n b·ªï ƒëi·ªÉm theo t·ª∑ l·ªá: 7 ng∆∞·ªùi A (17-23), 10 ng∆∞·ªùi B (7-16), 11 ng∆∞·ªùi C (1-6)
    let rank
    if (i < 7) {
      // Nh√≥m A: 17-23 ƒëi·ªÉm
      rank = Math.floor(Math.random() * 7) + 17
    } else if (i < 17) {
      // Nh√≥m B: 7-16 ƒëi·ªÉm
      rank = Math.floor(Math.random() * 10) + 7
    } else {
      // Nh√≥m C: 1-6 ƒëi·ªÉm
      rank = Math.floor(Math.random() * 6) + 1
    }
    
    randomPlayers.push({ name, rank })
  }
  
  // X√°o tr·ªôn th·ª© t·ª±
  for (let i = randomPlayers.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [randomPlayers[i], randomPlayers[j]] = [randomPlayers[j], randomPlayers[i]]
  }
  
  players.value = randomPlayers
  success.value = 'üé≤ ƒê√£ t·∫°o danh s√°ch ng·∫´u nhi√™n 28 ng∆∞·ªùi ch∆°i!'
}

// X√≥a ng∆∞·ªùi ch∆°i t·∫°i v·ªã tr√≠ index (trong sortedPlayers)
const deletePlayer = (index) => {
  const player = sortedPlayers.value[index]
  if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi ch∆°i "${player.name}"?`)) {
    // T√¨m v·ªã tr√≠ th·ª±c t·∫ø trong m·∫£ng players g·ªëc
    const realIndex = players.value.findIndex(p => p === player)
    if (realIndex !== -1) {
      players.value[realIndex] = { name: '', rank: null }
      success.value = `üóëÔ∏è ƒê√£ x√≥a ng∆∞·ªùi ch∆°i "${player.name}"`
      
      // Emit update immediately
      const validPlayers = players.value.filter(p => p.name && p.rank)
      emit('players-updated', validPlayers)
    }
  }
}

// T·∫°o ng·∫´u nhi√™n cho 1 ng∆∞·ªùi ch∆°i (trong sortedPlayers)
const fillRandomPlayer = (index) => {
  const player = sortedPlayers.value[index]
  
  const names = [
    'Li√™m', 'Ki·∫øp', 'F88', 'YB 1999', 'D√°nh ƒê√¥ng d·∫πp b·∫Øc', 'Pi', 'Trung con', 'Pheo',
    'Th·∫ßy Hi·ªáu Tr∆∞·ªüng', 'Ho√†ng Huy', 'Th√†nh Ph·∫°m', 'Vi·ªát B√©o', 'ƒêinh Xu√¢n H√†o', 'Dx T√°',
    'B·∫£nh', 'Hi·ªáp', 'B√© bom', 'Ng√¥ B·∫£o Long', 'T≈©n', 'Gi√°p Nguy·ªÖn', 'C·ª• gi√†', 'Kim Chung',
    'M√°y t√≠nh t·∫•t th·∫Øng', 'L∆∞u VƒÉn S·ªπ', 'Phong L√¢m', 'Tu·∫•n Tu·∫•n', 'Thang Tony', 'Koi'
  ]
  
  // T√¨m t√™n ch∆∞a ƒë∆∞·ª£c s·ª≠ d·ª•ng
  const usedNames = players.value.filter(p => p.name).map(p => p.name)
  let name
  do {
    name = names[Math.floor(Math.random() * names.length)]
  } while (usedNames.includes(name))
  
  // T·∫°o ƒëi·ªÉm ng·∫´u nhi√™n
  const rank = Math.floor(Math.random() * 23) + 1
  
  // T√¨m v·ªã tr√≠ th·ª±c t·∫ø trong m·∫£ng players g·ªëc
  const realIndex = players.value.findIndex(p => p === player)
  if (realIndex !== -1) {
    players.value[realIndex] = { name, rank }
    success.value = `üé≤ ƒê√£ t·∫°o ng·∫´u nhi√™n "${name}" v·ªõi ${rank} ƒëi·ªÉm`
    
    // Emit update immediately
    const validPlayers = players.value.filter(p => p.name && p.rank)
    emit('players-updated', validPlayers)
  }
}

// L·∫•y class cho badge category
const getRankBadgeClass = (rank) => {
  if (rank >= 17 && rank <= 23) return 'bg-red-100 text-red-700 border border-red-300'
  if (rank >= 7 && rank <= 16) return 'bg-yellow-100 text-yellow-700 border border-yellow-300'
  if (rank >= 1 && rank <= 6) return 'bg-green-100 text-green-700 border border-green-300'
  return 'bg-gray-100 text-gray-700 border border-gray-300'
}

// L·∫•y category c·ªßa rank
const getRankCategory = (rank) => {
  if (rank >= 17 && rank <= 23) return 'Tr·ª• C·ªôt'
  if (rank >= 7 && rank <= 16) return 'Trung B√¨nh'
  if (rank >= 1 && rank <= 6) return 'H·ªó Tr·ª£'
  return 'N/A'
}

// ƒê·∫øm s·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i theo category
const getCategoryCount = (category) => {
  return sortedPlayers.value.filter(player => {
    if (!player.rank) return false
    switch (category) {
      case 'A': return player.rank >= 17 && player.rank <= 23
      case 'B': return player.rank >= 7 && player.rank <= 16
      case 'C': return player.rank >= 1 && player.rank <= 6
      default: return false
    }
  }).length
}

const addPlayers = () => {
  error.value = ''
  success.value = ''
  
  // Filter out empty players
  const validPlayers = players.value.filter(p => p.name && p.rank)
  
  // Check count
  if (validPlayers.length !== 28) {
    error.value = `Vui l√≤ng nh·∫≠p ƒë·ªß 28 ng∆∞·ªùi ch∆°i. Hi·ªán t·∫°i: ${validPlayers.length} ng∆∞·ªùi.`
    return
  }
  
  // Validate rank range
  const invalidRank = validPlayers.find(p => p.rank < 1 || p.rank > 23)
  if (invalidRank) {
    error.value = `ƒêi·ªÉm s·ªë ph·∫£i trong kho·∫£ng 1-23.`
    return
  }
  
  // Validate duplicate names
  const names = validPlayers.map(p => p.name.trim())
  const uniqueNames = new Set(names)
  if (uniqueNames.size !== names.length) {
    error.value = 'C√≥ t√™n ng∆∞·ªùi ch∆°i b·ªã tr√πng l·∫∑p. Vui l√≤ng ki·ªÉm tra l·∫°i.'
    return
  }
  
  // Format data
  const formattedPlayers = validPlayers.map(p => ({
    name: p.name.trim(),
    rank: p.rank
  }))
  
  success.value = `‚úÖ ƒê√£ x√°c nh·∫≠n ${formattedPlayers.length} ng∆∞·ªùi ch∆°i!`
  emit('players-submitted', formattedPlayers)
}
</script>
